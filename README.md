# Segmentation Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö —É—á–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è VK.

## üîç –û –ø—Ä–æ–µ–∫—Ç–µ

–°–µ—Ä–≤–∏—Å —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
- –°–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `MAIL_GPT`, `CLOUD_DISCOUNT_30`)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–µ–≥–º–µ–Ω—Ç—ã
- **–ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API**: [segmentservice.example.com](http://51.250.39.113:5000/swagger/index.html)

## üåü –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚ö° –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö (1M+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):

```csharp
// SegmentService.cs
public async Task AssignSegmentToPercentageAsync(int segmentId, int percent, int batchSize = 1000)
{
    var totalUsers = await _db.Users.CountAsync();
    var usersToAssign = (int)(totalUsers * percent / 100.0);
    
    await _db.Database.ExecuteSqlRawAsync($@"
        INSERT INTO ""UserSegments"" (""UsersId"", ""SegmentsId"")
        SELECT ""Id"", {segmentId}
        FROM (
            SELECT ""Id"", random() as rnd
            FROM ""Users""
            WHERE ""Id"" NOT IN (
                SELECT ""UsersId"" FROM ""UserSegments"" 
                WHERE ""SegmentsId"" = {segmentId}
            )
            ORDER BY rnd
            LIMIT {batchSize}
        ) AS subquery
    ");
}

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (batchSize=1000)
- **–ù–∞—Ç–∏–≤–Ω—ã–π SQL** –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –≤—Å—Ç–∞–≤–æ–∫
- **–°–ª—É—á–∞–π–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞** —á–µ—Ä–µ–∑ `ORDER BY random()`
- **–§–æ–Ω–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ Hangfire

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç       | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è         |
|-----------------|--------------------|
| Backend         | ASP.NET Core 8     |
| Database        | PostgreSQL 15      |
| ORM             | Entity Framework Core 8 |
| –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è | Docker + Docker Compose |
| –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏  | Hangfire           |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è    | Swagger UI         |

## üìö API Endpoints

### –°–µ–≥–º–µ–Ω—Ç—ã

| –ú–µ—Ç–æ–¥   | –ü—É—Ç—å                          | –û–ø–∏—Å–∞–Ω–∏–µ                               |
|---------|-------------------------------|----------------------------------------|
| `GET`   | `/api/segments`               | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã                 |
| `POST`  | `/api/segments`               | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç                 |
| `DELETE`| `/api/segments/{name}`        | –£–¥–∞–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)          |
| `POST`  | `/api/segments/{name}/assign` | –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π     |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

| –ú–µ—Ç–æ–¥   | –ü—É—Ç—å                              | –û–ø–∏—Å–∞–Ω–∏–µ                               |
|---------|-----------------------------------|----------------------------------------|
| `GET`   | `/api/user`                       | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π           |
| `POST`  | `/api/user`                       | –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                  |
| `GET`   | `/api/user/{id}/segments`         | –ü–æ–ª—É—á–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è        |
| `POST`  | `/api/user/{id}/segments/{name}`  | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ–≥–º–µ–Ω—Ç       |
| `DELETE`| `/api/user/{id}/segments/{name}`  | –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ–≥–º–µ–Ω—Ç–∞      |

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è               | 10k users | 100k users | 1M users |
|------------------------|----------|-----------|---------|
| –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–µ–≥–º–µ–Ω—Ç   | 15ms     | 18ms      | 22ms    |
| –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ 10%      | 1.2s     | 4.5s      | 45s     |
| –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ 30%      | 3.8s     | 18s       | 2m10s   |
